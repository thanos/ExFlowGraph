### D) Implementation Gaps & Refactor Plan

This checklist identifies the discrepancies between the proposed ideal API and the current ExFlowGraph implementation. It outlines the necessary refactoring steps to align the code with the documentation-first approach.

| Prio | Gap Description                                                             | Where it shows in docs          | Current Code Location(s) Related                                             | Proposed Change (API/Module/Function)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Estimated Complexity | Notes                                                                                                                                                                                                                                                              |
| :--- | :-------------------------------------------------------------------------- | :------------------------------ | :--------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **P0** | **No central LiveView component entrypoint with `on_event` callback.**      | Quickstart, Component API       | `demo/lib/ex_flow_graph_web/components/ex_flow/canvas.ex`, `demo/lib/ex_flow_graph_web/live/flow_live.ex` | Create `lib/ex_flow_graph_web/components/ex_flow.ex` with a function component `<.ex_flow />` that accepts `id`, `graph`, `on_event`, and other assigns. This component will encapsulate `canvas.ex`, `node.ex`, `edge.ex`, and the JS hook. The `on_event` assign will be the primary mechanism for receiving events from the component. | L                    | This is the foundational change to establish the clean component API. It requires consolidating rendering and event dispatch logic.                                                                                                                                       |
| **P0** | **Graph state is a raw `LibGraph` struct; not a canonical `ExFlow.Graph` struct.** | Component API, Persistence      | `lib/ex_flow/core/graph.ex` is `LibGraph` wrapper, `demo/lib/ex_flow_graph_web/live/flow_live.ex` uses maps for node data. | Define `%ExFlow.Graph{}`, `%ExFlow.Graph.Node{}`, `%ExFlow.Graph.Edge{}` structs with the specified fields (id, type, position, data, ports, etc.). Refactor all internal operations (add_node, add_edge, update_node_position) to work with these structs. Provide `ExFlow.Graph` module with helper functions for immutable updates. | L                    | Essential for a type-safe, predictable, and stable API. This will involve significant changes to how graph data is represented internally and externally. `libgraph` should become an internal detail.                                                                  |
| **P0** | **Inconsistent client-to-server event names and payloads.**               | Quickstart, Component API       | `demo/lib/ex_flow_graph_web/live/flow_live.ex` handles `update_position`, `create_edge`. | Standardize event names and payloads as per the "Proposed Public API Spec" (e.g., `:node_drag_end` instead of `update_position`). Update the JS hook to emit these new events and payloads. The component should map these to the `on_event` callback. | M                    | Clear, consistent event names are crucial for developer ergonomics and future extensibility.                                                                                                                                                                   |
| **P1** | **`ExFlow.Graph.Serializer` needs to work with new `ExFlow.Graph` structs.** | Persistence                     | `lib/ex_flow/serializer.ex` currently converts to/from `FlowGraph.to_map` (LibGraph maps). | Update `ExFlow.Graph.Serializer` to serialize/deserialize the new `%ExFlow.Graph{}` structs to/from JSON-compatible maps, ensuring all fields (nodes, edges, selection, viewport) are correctly handled. | M                    | This ensures the persistence layer is compatible with the new canonical graph representation.                                                                                                                                                                |
| **P1** | **JS Hook logic for `selection`, `deletion`, and `node_creation` is missing or incomplete.** | Quickstart, Component API, Recipes | `demo/lib/ex_flow_graph_web/components/ex_flow/ex_flow.js` only handles dragging. | Implement client-side logic in `ex_flow.js` to handle node/edge selection (click, multi-select), deletion (backspace/delete key), and triggering new node creation events (e.g., via context menu click). Emit corresponding `selection_changed`, `nodes_deleted`, `edges_deleted`, `node_created` events. | L                    | These are core interactive features that need robust client-side implementation.                                                                                                                                                                               |
| **P1** | **`node_types` assign for custom node rendering is not implemented.**     | Component API, Recipes          | `demo/lib/ex_flow_graph_web/components/ex_flow/node.ex` is a fixed template. | Modify the main component to accept a `node_types` assign. When rendering a node, if a custom component is provided for its `type`, use that component; otherwise, fall back to a default renderer. | M                    | This is a key extensibility point for customizing the UI.                                                                                                                                                                                                      |
| **P1** | **No slots for `<:toolbar>` or `<:context_menu>` for component extensibility.** | Component API, Recipes          | `canvas.ex` has no slots.                                                    | Add `slots` definitions to the main component for a toolbar and a context menu. Pass relevant context (e.g., `selected_nodes`) to the context menu slot.                                                                                                                                                              | S                    | Essential for a flexible UI that allows users to add custom actions.                                                                                                                                                                                           |
| **P2** | **`ExFlow.HistoryManager` not integrated/demonstrated.**                    | Recipes                         | `lib/ex_flow/history_manager.ex` exists but is unused in the demo.           | Update the demo or create a dedicated recipe that shows how to integrate `ExFlow.HistoryManager` with the `on_event` callback to provide undo/redo functionality. The history manager should likely work with the new `ExFlow.Graph` structs. | M                    | Leverage existing functionality to provide a powerful feature.                                                                                                                                                                                                 |
| **P2** | **Installation process for JS/CSS assets is unclear and manual.**         | Installation                    | `demo/assets` files are copied/vendored.                                     | Create a mix task or clear instructions for copying `ex_flow_graph.js` and `ex_flow_graph.css` to the user's `assets/vendor` directory (or similar). Potentially ship assets directly in `priv/static`.                                 | S                    | Streamline the setup process for end-users.                                                                                                                                                                                                                    |
| **P2** | **The `demo` application should be updated to reflect the new API and best practices.** | Quickstart, Demo Walkthrough    | `demo/` directory                                                            | Refactor the `demo` application's `FlowLive` to use the new `<.ex_flow>` component, `ExFlow.Graph` structs, and the `on_event` callback. Update `FlowLive` to use a `GraphContext` for persistence.                                     | M                    | The demo is a critical example for users; it must align with the recommended usage.                                                                                                                                                                            |
| **P3** | **No `ExFlow.Graph.Context` module for database operations as suggested in docs.** | Persistence                     | Current `ExFlow.Storage.Ecto` and `ExFlow.GraphRecord`.                      | Create `lib/ex_flow/graph_context.ex` which provides a clean, domain-specific API for interacting with the `ExFlow.GraphRecord` and `ExFlow.Graph.Serializer` to load/save `ExFlow.Graph` structs.                                           | M                    | This provides a clear pattern for persistence, separating concerns from the LiveView.                                                                                                                                                                          |
| **P3** | **`ExFlow.Graph` should support initial `selection` and `viewport` assigns.** | Component API                   | UNCONFIRMED: Current `LibGraph` doesn't include selection/viewport.          | Add `selection` (MapSet of node/edge IDs) and `viewport` (map with x, y, zoom) fields to `%ExFlow.Graph{}` struct. Update internal rendering to honor these.                                                                                   | S                    | Allows initializing the component with pre-selected elements or a specific view.                                                                                                                                                                            |

*(UNCONFIRMED: To verify current `LibGraph` and its wrappers do not inherently support selection or viewport, `grep -r "selection\|viewport" lib/ex_flow/core/graph.ex` and `lib/ex_flow.ex`)*
*(UNCONFIRMED: To verify current JS hook for event details and payload structures, `grep -r "pushEvent" demo/lib/ex_flow_graph_web/components/ex_flow/ex_flow.js`)*
*(UNCONFIRMED: To verify how demo assets are currently integrated, `ls assets/` and check `config/config.exs`)*
